# 工作计划 tunecore

本文档包含工作流 tunecore 的动态任务规划和分解。

## 工作流信息
- 工作ID: tunecore
- 创建时间: 2024-12-19
- 状态: 已完成
- 描述: 调整src/core/模块设计，实现优雅的按需加载机制和模块分块
- 总体进度: 100%
- 特别注意：不要做历史纪录，只更新最后结果！

## 任务树

- T1 [100%] 模块架构重构
  - T1.1 [100%] 更新核心头文件
    - T1.1.1 [100%] 更新module.h支持按需加载
    - T1.1.2 [100%] 更新astc.h适配新架构
  - T1.2 [100%] 模块合并重构
    - T1.2.1 [100%] 创建layer0模块(memory+utils+std+libdl)
    - T1.2.2 [100%] 创建pipeline包结构
    - T1.2.3 [100%] 创建compiler模块(jit+aot+ffi)
    - T1.2.4 [100%] 保持libc模块独立
  - T1.3 [100%] 增强module_module
    - T1.3.1 [100%] 实现智能路径解析
    - T1.3.2 [100%] 实现按需加载接口
    - T1.3.3 [100%] 实现符号解析机制
  - T1.4 [100%] 清理旧模块（先改后缀为.todelete）
  - T1.5 [100%] 调整构建脚本 build_core.sh
  - T1.5.1 [0%] 测试 build_core.sh 如果有问题就修复
- T2 [100%] 文档更新
  - T2.1 [100%] 更新modules.md文档
  - T2.2 [100%] 验证构建系统兼容性

## 任务详情

### T1: 模块架构重构
- 优先级: 高
- 依赖: 无
- 描述: 重构src/core/模块系统，实现优雅的按需加载和模块分块机制。

### T1.1: 更新核心头文件
- 优先级: 高
- 依赖: 无
- 描述: 更新核心头文件以支持新的模块架构。

### T1.1.1: 更新module.h支持按需加载
- 优先级: 高
- 依赖: 无
- 描述: 在module.h中添加按需加载接口，支持路径形式的模块加载。
- 完成标准: 
  - 添加load_module(path)接口
  - 添加智能文件名解析功能
  - 添加符号解析接口module->sym()

### T1.1.2: 更新astc.h适配新架构
- 优先级: 中
- 依赖: T1.1.1
- 描述: 确保astc.h与新的模块架构兼容。

### T1.2: 模块合并重构
- 优先级: 高
- 依赖: T1.1
- 描述: 按照讨论的架构重构现有模块。

### T1.2.1: 创建layer0模块
- 优先级: 高
- 依赖: T1.1.1
- 描述: 合并memory+utils+std+libdl为layer0基础模块。
- 完成标准:
  - 创建src/core/modules/layer0.c
  - 实现统一的基础服务接口
  - 包含内存管理、工具函数、标准库、动态加载功能

### T1.2.2: 创建pipeline包结构
- 优先级: 高
- 依赖: T1.2.1
- 描述: 创建pipeline包结构，包含前端、后端、执行等子模块。
- 完成标准:
  - 创建src/core/modules/pipeline/目录
  - 创建frontend.c (c2astc)
  - 创建backend.c (codegen+astc2native)
  - 创建execution.c (astc+vm)

### T1.2.3: 创建compiler模块
- 优先级: 中
- 依赖: T1.2.1
- 描述: 合并jit+aot+ffi为统一的编译器模块。
- 完成标准:
  - 创建src/core/modules/compiler.c
  - 实现统一的编译器接口
  - 支持JIT、AOT、FFI三种模式

### T1.2.4: 保持libc模块独立
- 优先级: 低
- 依赖: 无
- 描述: 确保libc模块保持独立，为脱离tinycc做准备。

### T1.3: 增强module_module
- 优先级: 高
- 依赖: T1.2
- 描述: 增强模块管理器以支持新的按需加载机制。

### T1.3.1: 实现智能路径解析
- 优先级: 高
- 依赖: T1.2.2
- 描述: 实现智能路径解析，支持"./module"自动解析为"./module_x64_64.native"。
- 完成标准:
  - 实现resolve_native_file()函数
  - 支持架构自动检测
  - 支持包路径解析（如"pipeline/frontend"）

### T1.3.2: 实现按需加载接口
- 优先级: 高
- 依赖: T1.3.1
- 描述: 实现load_module()接口，支持按需加载.native文件。
- 完成标准:
  - 实现load_module()函数
  - 与现有native_module系统集成
  - 支持模块生命周期管理

### T1.3.3: 实现符号解析机制
- 优先级: 高
- 依赖: T1.3.2
- 描述: 实现module->sym()接口，支持符号解析和调用。
- 完成标准:
  - 实现符号解析接口
  - 支持函数指针返回
  - 支持错误处理

### T2: 文档更新
- 优先级: 中
- 依赖: T1
- 描述: 更新相关文档以反映新的模块架构。

### T2.1: 更新modules.md文档
- 优先级: 中
- 依赖: T1.3
- 描述: 更新模块设计文档以反映新的架构。

### T2.2: 验证构建系统兼容性
- 优先级: 中
- 依赖: T1.3
- 描述: 确保构建系统与新的模块结构兼容。

## 动态规划笔记

- 优先实现layer0模块，作为其他模块的基础
- pipeline包结构需要仔细设计目录结构
- module_module的增强是关键，需要与现有native_module系统良好集成
- 考虑分阶段实施，先实现基础功能，再完善高级特性 