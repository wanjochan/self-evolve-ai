# 工作计划 core_c99

本文档包含基于PRD.md推进src/core/和src/c99/目录开发的工作计划。

## 工作流信息
- 工作ID: core_c99
- 创建时间: 2023-06-20
- 状态: 进行中
- 描述: 根据产品需求文档实现核心模块和C99编译器功能
- 总体进度: 60%

## 任务树

- T1 [75%] 核心模块开发 (src/core/)
  - T1.1 [100%] 需求分析与架构设计
  - T1.2 [100%] ASTC模块实现
    - T1.2.1 [100%] astc.h接口定义
    - T1.2.2 [100%] astc.c核心功能
    - T1.2.3 [100%] 内存管理系统
  - T1.3 [85%] 转换器模块
    - T1.3.1 [100%] astc2native转换器
      - T1.3.1.1 [100%] x64代码生成器
      - T1.3.1.2 [100%] ARM64代码生成器
      - T1.3.1.3 [100%] 转换器核心逻辑
    - T1.3.2 [40%] c2astc转换器
  - T1.4 [40%] JIT编译模块
    - T1.4.1 [70%] jit.h接口定义
    - T1.4.2 [30%] jit.c实现
  - T1.5 [20%] 模块集成
    - T1.5.1 [40%] 模块间接口对接
    - T1.5.2 [0%] 集成测试
  - T1.6 [0%] 模块化重构 [新增]
    - T1.6.1 [0%] core接口完善
    - T1.6.2 [0%] 扩展机制设计
    - T1.6.3 [0%] 通用功能提升

- T2 [45%] C99编译器开发 (src/c99/)
  - T2.1 [85%] 前端模块
    - T2.1.1 [90%] 词法分析器
    - T2.1.2 [80%] 语法分析器
    - T2.1.3 [85%] 语义分析
  - T2.2 [30%] 后端模块
    - T2.2.1 [50%] 中间代码生成
    - T2.2.2 [20%] 代码优化
    - T2.2.3 [10%] 目标代码生成
  - T2.3 [35%] 标准库实现
    - T2.3.1 [90%] c99_stdio实现
    - T2.3.2 [0%] 其他标准库函数
  - T2.4 [0%] 编译器工具链
    - T2.4.1 [0%] 构建脚本优化
    - T2.4.2 [0%] 错误处理改进
  - T2.5 [0%] 模块化重构 [新增]
    - T2.5.1 [0%] AST统一
    - T2.5.2 [0%] 代码生成复用
    - T2.5.3 [0%] 优化器集成

- T3 [15%] 集成与测试
  - T3.1 [40%] 单元测试完善
  - T3.2 [20%] 集成测试
  - T3.3 [0%] 性能测试
  - T3.4 [0%] 文档更新

## 任务详情

### T1: 核心模块开发
- 优先级: 高
- 依赖: PRD.md核心模块规范
- 负责人: [core_team_lead]
- 截止日期: 2023-07-15
- 描述: 实现系统核心模块，包括ASTC、转换器和JIT编译功能。

### T1.2: ASTC模块实现
- 优先级: 高
- 依赖: T1.1
- 描述: 实现抽象语法树代码(ASTC)的核心功能。
- 进行中工作: 完善astc.c中的树遍历和转换功能，解决内存管理问题。
- 相关文件: src/core/astc.h, src/core/astc.c

### T1.3.1: astc2native转换器
- 优先级: 高
- 依赖: T1.2.1
- 描述: 实现ASTC到本地代码的转换功能。
- 进行中工作: 已完成核心转换逻辑，包括所有基本指令的实现。
- 相关文件: src/core/convertor/astc2native.c, src/core/convertor/astc2native.h
- 技术挑战: 确保生成的本地代码在多平台上兼容。

### T2.1: 前端模块
- 优先级: 高
- 依赖: PRD.md编译器规范
- 描述: 实现C99编译器的前端功能，包括词法分析、语法分析和语义分析。
- 进行中工作: 已完成语义分析核心功能，包括类型检查、作用域管理和符号表操作。
- 相关文件: src/c99/frontend/c99_semantic.c, src/c99/frontend/c99_semantic.h

### T2.3: 标准库实现
- 优先级: 中
- 依赖: T2.1
- 描述: 实现C99标准库的基本功能。
- 进行中工作: 已完成c99_stdio的主要功能，包括文件操作、I/O和格式化输出。
- 相关文件: src/c99/stdlib/c99_stdio.c, src/c99/stdlib/c99_stdio.h
- 技术决策:
  - 使用统一的格式化输出实现
  - 支持所有C99格式说明符和修饰符
  - 实现了安全的字符串操作
  - 添加了完整的错误处理

### T1.6: 模块化重构 [新增]
- 优先级: 高
- 依赖: T1.1, T1.2, T1.3
- 描述: 完善core模块接口设计，建立清晰的扩展机制。
- 进行中工作:
  - 分析现有模块化问题
  - 设计改进方案
  - 规划重构步骤
- 相关文件: src/core/目录下所有文件
- 技术挑战:
  - 保持向后兼容性
  - 确保接口稳定性
  - 平衡灵活性和复杂度

### T2.5: C99编译器模块化重构 [新增]
- 优先级: 高
- 依赖: T1.6
- 描述: 重构C99编译器以充分利用core模块功能。
- 进行中工作:
  - 统一AST表示
  - 复用代码生成功能
  - 集成core优化器
- 相关文件: src/c99/目录下所有文件
- 技术挑战:
  - 最小化重构影响
  - 保持功能正确性
  - 优化性能表现

## 动态规划笔记

- T1.2.2中的内存管理问题已解决，不再影响T1.3的进度。
- T2.1.3语义分析功能已完成主要实现，包括类型检查、作用域管理和符号表操作。
- T2.3.1 c99_stdio已完成主要功能，包括完整的格式化I/O支持。
- 根据初步测试结果，T1.4 JIT编译模块可能需要重新设计部分接口。
- T2.3标准库实现可以与T2.2并行推进，不必等待后端完全完成。
- 发现模块化问题需要优先解决，影响后续开发效率
- T1.6和T2.5的重构工作可以与其他任务并行进行
- 建议先完成core模块接口设计，再逐步重构C99编译器

## 下一步行动

1. ~~解决T1.2.2中的内存管理问题，完成astc.c核心功能~~ [已完成]
2. ~~实现T1.3.1.1和T1.3.1.2的代码生成器~~ [已完成]
3. ~~完成T1.3.1.3转换器核心逻辑的剩余工作~~ [已完成]
4. ~~完成T2.1.3语义分析功能的主要实现~~ [已完成]
5. ~~完成T2.3.1 c99_stdio的主要功能~~ [已完成]
6. 开始T1.6.1 core接口完善工作
7. 同时启动T2.3.2其他标准库函数的实现
8. 准备T3.1单元测试框架，优先覆盖已完成的核心功能
