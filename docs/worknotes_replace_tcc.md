# Replace TinyCC 工作笔记

## 基本信息
- **工作ID**: replace_tcc
- **创建时间**: 2025-07-16
- **负责人**: AI Assistant
- **当前状态**: PLANNING
- **优先级**: 高

## 当前进度状态 (2025-07-16)
- **总体进度: 0%**
- **当前阶段: 项目启动，依赖分析准备中**
- **下一步: 分析项目中所有cc.sh使用情况**

## 项目背景和动机

### 为什么要替换TinyCC？

1. **实现完全自主**: 项目目标是AI自我进化，依赖外部编译器与此愿景不符
2. **无外部依赖**: 建立真正的无外部依赖基准线，为后续进化奠定基础
3. **技术成熟度**: c99bin已经100%完成，具备替代TinyCC的技术基础
4. **控制权**: 完全掌控编译过程，可以根据AI进化需求定制编译器

### 当前技术基础

#### c99bin编译器优势
- ✅ **完全自主开发**: 无任何外部依赖
- ✅ **功能完整**: JIT、缓存、ELF/PE生成
- ✅ **接口兼容**: c99bin.sh提供cc.sh兼容接口
- ✅ **测试验证**: 完整的测试套件验证
- ✅ **跨平台**: Linux完全支持，其他平台部分支持

#### 当前限制
- ⚠️ **简单C程序**: 主要支持Hello World、简单返回值程序
- ⚠️ **单文件编译**: 不支持多文件项目
- ⚠️ **有限库支持**: 标准库支持有限
- ⚠️ **复杂语法**: 对复杂C语法支持不完整

## 技术分析

### 项目当前编译器使用情况

#### 主要编译脚本
1. **cc.sh**: TinyCC包装器，项目主要编译工具
2. **c99.sh**: 智能编译器选择器
3. **build_*.sh**: 各种构建脚本
4. **c99bin.sh**: 新的c99bin包装器 (已完成)

#### 编译场景分析
1. **核心模块编译**: layer0, pipeline, compiler, libc模块
2. **工具链编译**: c2astc, astc2native等工具
3. **测试程序编译**: 各种测试用例
4. **示例程序编译**: examples目录下的程序

### 替换策略

#### 渐进式替换方案
```
Phase 1: 简单程序替换 (目标: 30%覆盖率)
├── 测试程序编译
├── 简单示例程序
└── 单文件工具

Phase 2: 核心组件替换 (目标: 70%覆盖率)
├── 部分核心模块
├── 简化的工具链
└── 基础构建脚本

Phase 3: 完全替换 (目标: 100%覆盖率)
├── 所有核心模块
├── 完整工具链
└── 移除TinyCC依赖
```

#### 技术路线图
1. **依赖分析**: 扫描所有cc.sh使用，分类编译场景
2. **兼容性测试**: 测试c99bin.sh在各种场景下的表现
3. **功能增强**: 根据需要扩展c99bin功能
4. **渐进迁移**: 按复杂度从低到高逐步替换
5. **验证测试**: 确保所有功能正常工作
6. **清理优化**: 移除TinyCC相关代码，优化构建流程

## 状态追踪

#### 状态追踪更新
- 当前状态: PLANNING
- 状态变更原因: 新项目启动，c99bin技术基础已就绪
- 下一步计划: 开始依赖分析，制定详细替换计划

## 里程碑记录
- 里程碑1: 2025-07-16 - 项目启动，工作计划和笔记创建

## 技术决策记录

### 决策1: 采用渐进式替换策略
- **时间**: 2025-07-16
- **决策**: 采用渐进式替换而非一次性全面替换
- **原因**: 降低风险，确保系统稳定性，便于问题定位和回退
- **影响**: 需要维护混合编译环境一段时间

### 决策2: 保持cc.sh接口兼容性
- **时间**: 2025-07-16
- **决策**: 通过c99bin.sh保持与cc.sh的接口兼容性
- **原因**: 最小化现有脚本的修改工作量
- **影响**: 需要确保c99bin.sh功能完整性

## 风险管理

### 已识别风险

#### 技术风险
1. **兼容性风险**: c99bin可能无法编译复杂C代码
   - 缓解: 渐进式迁移，保留回退机制
   - 监控: 持续兼容性测试

2. **性能风险**: c99bin性能可能不如TinyCC
   - 缓解: 性能基准测试，优化关键路径
   - 监控: 构建时间和可执行文件性能监控

3. **稳定性风险**: c99bin可能存在未发现的bug
   - 缓解: 全面测试，长期稳定性验证
   - 监控: 错误日志和异常监控

#### 项目风险
1. **时间风险**: 替换工作可能比预期复杂
   - 缓解: 分阶段实施，设置检查点
   - 监控: 进度跟踪和里程碑评估

2. **资源风险**: 可能需要大量测试和验证工作
   - 缓解: 自动化测试，重用现有测试基础设施
   - 监控: 工作量评估和资源分配

## 测试策略

### 测试层次
1. **单元测试**: 测试c99bin.sh各项功能
2. **集成测试**: 测试在现有构建流程中的集成
3. **回归测试**: 确保现有功能不受影响
4. **性能测试**: 对比TinyCC的性能表现
5. **稳定性测试**: 长期运行和压力测试

### 测试覆盖范围
- ✅ 简单C程序编译
- ⚠️ 复杂C程序编译 (需要增强)
- ✅ 命令行接口兼容性
- ⚠️ 多文件项目编译 (需要实现)
- ✅ 错误处理和诊断
- ⚠️ 库链接功能 (需要实现)

## 成功指标

### 量化指标
- **覆盖率**: 使用c99bin.sh的构建任务比例
- **性能**: 构建时间不超过TinyCC的120%
- **稳定性**: 错误率低于1%
- **兼容性**: 95%以上的现有代码可以编译

### 质量指标
- **功能完整性**: 所有核心功能正常工作
- **用户体验**: 构建过程透明，错误信息清晰
- **维护性**: 代码清晰，文档完整
- **可扩展性**: 便于后续功能扩展

## 下一步行动计划

### 立即行动 (本周)
1. **T1.1 依赖分析**: 扫描项目中所有cc.sh使用情况
2. **T1.2 可行性评估**: 测试c99bin.sh在关键场景中的表现
3. **环境准备**: 设置测试环境和基准测试

### 短期计划 (下周)
1. **T2.1 构建系统改造**: 开始修改核心构建脚本
2. **T1.3 场景识别**: 识别需要特殊处理的编译场景
3. **T1.4 策略制定**: 制定详细的渐进式替换策略

### 中期计划 (2-4周)
1. **T3.1 核心组件迁移**: 开始迁移核心模块编译
2. **T4.1 兼容性增强**: 根据需要增强c99bin功能
3. **T5.1 回归测试**: 建立全面的测试体系
