# 工作计划 modulize

本文档包含工作流 modulize 的动态任务规划和分解。

## 工作流信息
- 工作ID: modulize
- 创建时间: 2024-12-19
- 状态: 进行中
- 描述: 优化和完善 src/core/ 模块化底层，添加 FFI 和 AOT 模块，为 PRD.md 开发做准备
- 总体进度: 25%
- 特别注意：不要做历史纪录，只更新最后结果！

## 任务树

- T1 [60%] 模块系统理顺
  - T1.1 [100%] 当前模块系统分析
  - T1.2 [100%] 完善动态模块加载系统
  - T1.3 [0%] 自动依赖解析
  - T1.4 [0%] 符号命名规范化
  - T1.5 [0%] 错误处理增强
- T2 [0%] 模块合并优化
  - T2.1 [0%] 编译相关模块合并 (astc2native, c2astc, codegen)
  - T2.2 [0%] 模块接口优化
  - T2.3 [0%] 性能优化
- T3 [0%] 新增核心模块
  - T3.1 [0%] FFI 模块实现
  - T3.2 [0%] AOT 模块实现
  - T3.3 [0%] 模块集成测试
- T4 [0%] 验证和完善
  - T4.1 [0%] 编译测试
  - T4.2 [0%] 功能验证
  - T4.3 [0%] 文档更新

## 任务详情

### T1: 模块系统理顺
- 优先级: 高
- 依赖: 无
- 描述: 完善现有模块系统，解决注册、依赖、符号等问题

### T1.1: 当前模块系统分析
- 优先级: 高
- 依赖: 无
- 完成时间: 2024-12-19
- 描述: 深入分析当前模块系统架构、优缺点和待优化点
- 完成标准: 完成系统分析报告

### T1.2: 完善动态模块加载系统
- 优先级: 高
- 依赖: T1.1
- 完成时间: 2024-12-19
- 描述: 重新设计为动态.native文件加载系统，而非静态注册机制
- 完成标准: 能够动态加载.native文件并解析符号
- 实现内容:
  - ✅ 重新实现module_load()函数支持.native文件加载
  - ✅ 实现.native文件格式解析 (NATV magic, 导出表等)
  - ✅ 实现动态符号解析机制
  - ✅ 添加module_unload()函数支持模块卸载
  - ✅ 更新Module结构支持动态加载信息
  - ✅ 清理错误的静态注册代码
  - ✅ 创建测试验证动态加载机制

### T1.3: 自动依赖解析
- 优先级: 高
- 依赖: T1.2
- 描述: 实现自动依赖解析，包括循环依赖检测

### T1.4: 符号命名规范化
- 优先级: 中
- 依赖: T1.2
- 描述: 统一所有模块的符号命名规范

### T1.5: 错误处理增强
- 优先级: 中
- 依赖: T1.2
- 描述: 增强错误处理机制，提供详细错误信息

### T2: 模块合并优化
- 优先级: 高
- 依赖: T1
- 描述: 按照 PRD.md 建议合并编译相关模块

### T2.1: 编译相关模块合并
- 优先级: 高
- 依赖: T1.2
- 描述: 将 astc2native_module, c2astc_module, codegen_module 合并为 compiler_module
- 挑战: 保持向后兼容性

### T3: 新增核心模块
- 优先级: 高
- 依赖: T1, T2
- 描述: 添加 FFI 和 AOT 模块，支持 PRD.md 的三层架构

### T3.1: FFI 模块实现
- 优先级: 高
- 依赖: T1.2
- 描述: 实现 Foreign Function Interface 模块，支持跨语言调用

### T3.2: AOT 模块实现
- 优先级: 高
- 依赖: T1.2, T2.1
- 描述: 实现 Ahead-of-Time 编译模块

### T4: 验证和完善
- 优先级: 中
- 依赖: T1, T2, T3
- 描述: 验证所有模块功能，确保系统稳定

## 动态规划笔记

- 当前模块系统设计优秀，主要问题在于注册机制和依赖解析
- FFI 和 AOT 模块是 PRD.md 三层架构的关键组件
- 需要特别注意模块合并时的向后兼容性
- 优先解决模块注册问题，这是其他优化的基础 