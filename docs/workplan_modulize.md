# 工作计划 modulize

本文档包含工作流 modulize 的动态任务规划和分解。

## 工作流信息
- 工作ID: modulize
- 创建时间: 2024-03-26
- 状态: 进行中
- 描述: 重构 src/core 为纯模块化架构
- 总体进度: 85%
- 特别注意：不要做历史纪录，只记录最终结果！

## 任务树

- T1 [100%] 核心模块系统实现
  - T1.1 [100%] 设计模块接口
  - T1.2 [100%] 实现 module.[h|c]
  - T1.3 [100%] 实现基础设施
    - T1.3.1 [100%] 模块加载机制
    - T1.3.2 [100%] 符号解析系统
    - T1.3.3 [100%] 依赖管理
- T2 [100%] 现有功能模块化
  - T2.1 [100%] VM模块转换
  - T2.2 [100%] Memory模块转换
  - T2.3 [100%] ASTC模块转换
  - T2.4 [100%] Native模块转换
  - T2.5 [100%] Utils模块转换
  - T2.6 [100%] JIT模块转换
  - T2.7 [100%] Convertor模块转换
    - T2.7.1 [100%] C2ASTC模块转换
    - T2.7.2 [100%] ASTC2Native模块转换
    - T2.7.3 [100%] Codegen模块转换
- T3 [100%] 测试与验证
  - T3.1 [100%] 单元测试
  - T3.2 [100%] 集成测试
  - T3.3 [100%] 性能测试
- T4 [100%] 完成纯模块化架构
  - T4.1 [100%] 移除原始实现文件
  - T4.2 [100%] 重构头文件结构
  - T4.3 [100%] 更新构建系统
  - T4.4 [100%] 最终验证测试
- T5 [80%] 清理和测试
  - T5.1 [100%] 清理无用文件
  - T5.2 [100%] 根据PRD.md设计模块测试
  - T5.3 [40%] 执行模块测试
- T6 [85%] 调整Loader和Runtime
  - T6.1 [100%] 修复Stage 1架构
  - T6.2 [100%] 调整Loader实现
  - T6.3 [70%] 优化Runtime模块
  - T6.4 [70%] 实现原生模块构建工具
- T7 [30%] 实现三层架构工具链
  - T7.1 [80%] 实现build_native_module工具
  - T7.2 [20%] 实现simple_loader加载器
  - T7.3 [0%] 实现ASTC程序示例
  - T7.4 [0%] 实现完整构建流程

## 任务详情

### T1: 核心模块系统实现
- 优先级: 高
- 依赖: 无
- 描述: 实现最小化的模块系统核心

### T1.1: 设计模块接口
- 优先级: 高
- 依赖: 无
- 描述: 设计简洁而强大的模块接口
- 完成标准: 接口设计文档完成并评审

### T1.2: 实现 module.[h|c]
- 优先级: 高
- 依赖: T1.1
- 描述: 实现核心模块系统
- 完成标准: 基础功能测试通过

### T1.3: 实现基础设施
- 优先级: 高
- 依赖: T1.2
- 描述: 实现模块系统所需的基础设施
- 完成标准: 所有基础功能可用

### T2: 现有功能模块化
- 优先级: 中
- 依赖: T1
- 描述: 将现有功能转换为模块

### T2.1: VM模块转换
- 优先级: 高
- 依赖: T1
- 描述: 将VM系统转换为模块
- 完成标准: VM功能完全模块化并测试通过

### T2.2: Memory模块转换
- 优先级: 高
- 依赖: T1
- 描述: 将内存管理转换为模块
- 完成标准: 内存管理功能完全模块化并测试通过

### T2.3: ASTC模块转换
- 优先级: 中
- 依赖: T1
- 描述: 将ASTC相关功能转换为模块
- 完成标准: ASTC功能完全模块化并测试通过

### T2.4: Native模块转换
- 优先级: 中
- 依赖: T1
- 描述: 将Native模块系统转换为新模块架构
- 完成标准: Native功能完全模块化并测试通过

### T2.5: Utils模块转换
- 优先级: 低
- 依赖: T1
- 描述: 将工具函数转换为模块
- 完成标准: 工具函数完全模块化并测试通过

### T2.6: JIT模块转换
- 优先级: 高
- 依赖: T1
- 描述: 将JIT系统转换为模块
- 完成标准: JIT功能完全模块化并测试通过，jit目录下的文件被正确模块化
- 状态: 已完成
- 实现: 创建了jit_module.c，将JIT功能完全封装在模块中，添加了对memory和utils模块的依赖

### T2.7: Convertor模块转换
- 优先级: 高
- 依赖: T1
- 描述: 将转换器系统转换为模块
- 完成标准: 所有转换器功能完全模块化并测试通过，convertor目录下的文件被正确模块化

### T2.7.1: C2ASTC模块转换
- 优先级: 高
- 依赖: T2.7
- 描述: 将C到ASTC转换器转换为模块
- 完成标准: C2ASTC功能完全模块化并测试通过
- 状态: 已完成
- 实现: 创建了c2astc_module.c，将C到ASTC转换功能完全封装在模块中，添加了对memory、astc和utils模块的依赖

### T2.7.2: ASTC2Native模块转换
- 优先级: 高
- 依赖: T2.7
- 描述: 将ASTC到Native转换器转换为模块
- 完成标准: ASTC2Native功能完全模块化并测试通过
- 状态: 已完成
- 实现: 创建了astc2native_module.c，将ASTC到Native转换功能完全封装在模块中，添加了对memory、utils和c2astc模块的依赖

### T2.7.3: Codegen模块转换
- 优先级: 高
- 依赖: T2.7
- 描述: 将代码生成器转换为模块
- 完成标准: 所有代码生成器功能完全模块化并测试通过
- 状态: 已完成
- 实现: 创建了codegen_module.c，将代码生成功能完全封装在模块中，添加了对memory、astc和utils模块的依赖

### T3: 测试与验证
- 优先级: 高
- 依赖: T2
- 描述: 全面测试新的模块化系统

### T3.1: 单元测试
- 优先级: 高
- 依赖: T2
- 描述: 对各个模块进行单元测试
- 完成标准: 所有模块的单元测试通过

### T3.2: 集成测试
- 优先级: 高
- 依赖: T3.1
- 描述: 测试模块间的交互和依赖关系
- 完成标准: 所有集成测试通过

### T3.3: 性能测试
- 优先级: 中
- 依赖: T3.2
- 描述: 评估模块系统的性能特性
- 完成标准: 性能测试结果满足要求

### T4: 完成纯模块化架构
- 优先级: 最高
- 依赖: T2, T3
- 描述: 完成向纯模块化架构的过渡
- 完成标准: src/core目录只包含module.[h|c]，所有其他功能都在modules目录中

### T4.1: 移除原始实现文件
- 优先级: 高
- 依赖: T2
- 描述: 移除已经模块化的原始实现文件
- 完成标准: 所有原始实现文件被移除，src/core目录只包含module.[h|c]和modules/目录
- 状态: 已完成
- 实现: 创建了cleanup_original_files.sh脚本，将原始文件备份并移除

### T4.2: 重构头文件结构
- 优先级: 高
- 依赖: T4.1
- 描述: 重构头文件结构，确保公共接口与实现分离
- 完成标准: 公共接口头文件位于include/core/目录，实现文件位于src/core/目录
- 状态: 已完成
- 实现: 创建了restructure_headers.sh脚本，创建了include目录结构和公共接口头文件

### T4.3: 更新构建系统
- 优先级: 高
- 依赖: T4.2
- 描述: 更新构建系统以支持模块化架构
- 完成标准: Makefile更新，支持编译和链接模块化架构
- 状态: 已完成
- 实现: 创建了update_build_system.sh脚本，更新了Makefile以支持模块化架构

### T4.4: 最终验证测试
- 优先级: 高
- 依赖: T4.3
- 描述: 运行最终验证测试，确保模块化架构正常工作
- 完成标准: 所有测试通过，模块化架构验证成功
- 状态: 已完成
- 实现: 创建了run_validation_tests.sh脚本，运行了单元测试、集成测试、性能测试和模块加载测试

### T5: 清理和测试
- 优先级: 高
- 依赖: T4
- 描述: 清理src/core中无用文件并进行模块测试
- 完成标准: 无用文件被适当处理，模块测试全部通过
- 状态: 进行中
- 实现: 创建了cleanup_core_files.sh脚本处理无用文件，设计了模块测试框架

### T5.1: 清理无用文件
- 优先级: 高
- 依赖: T4
- 描述: 将src/core中无用的文件移至src/old/或重命名为.todelete
- 完成标准: 所有无用文件被适当处理，src/core目录保持整洁
- 状态: 已完成
- 实现: 创建了cleanup_core_files.sh脚本，将已模块化的文件移至src/core/old/，将其他非必要文件标记为.todelete

### T5.2: 根据PRD.md设计模块测试
- 优先级: 高
- 依赖: T5.1
- 描述: 基于PRD.md中的设计要求设计全面的模块测试
- 完成标准: 测试计划完成，覆盖所有关键模块功能
- 状态: 已完成
- 实现: 创建了module_tests.sh脚本和core_module_tests.c测试框架，设计了全面的模块测试

### T5.3: 执行模块测试
- 优先级: 高
- 依赖: T5.2
- 描述: 执行设计的模块测试，验证模块化架构的正确性
- 完成标准: 所有测试通过，模块化架构符合PRD.md的设计要求
- 状态: 进行中
- 实现: 创建了run_module_tests.sh脚本，正在执行测试并修复发现的问题

### T6: 调整Loader和Runtime
- 优先级: 高
- 依赖: T5
- 描述: 调整Loader和Runtime以适应Stage 1架构
- 完成标准: Loader和Runtime正确实现并支持Stage 1架构
- 状态: 进行中
- 实现: 已创建fix_stage1_architecture.sh、adjust_loader.sh和optimize_runtime.sh脚本

### T6.1: 修复Stage 1架构
- 优先级: 高
- 依赖: T5
- 描述: 根据PRD.md修复Stage 1架构中的问题
- 完成标准: Stage 1架构符合PRD.md的设计要求
- 状态: 已完成
- 实现: 创建了fix_stage1_architecture.sh脚本，实现了三层架构的基础框架，创建了详细的架构文档

### T6.2: 调整Loader实现
- 优先级: 高
- 依赖: T6.1
- 描述: 调整Loader实现，确保正确加载Runtime模块
- 完成标准: Loader能够正确加载不同架构的Runtime模块
- 状态: 已完成
- 实现: 创建了adjust_loader.sh脚本，实现了架构检测和模块加载功能，创建了构建脚本

### T6.3: 优化Runtime模块
- 优先级: 高
- 依赖: T6.2
- 描述: 优化Runtime模块，确保正确加载和执行ASTC程序
- 完成标准: Runtime模块能够正确加载和执行ASTC程序
- 状态: 进行中
- 实现: 创建了optimize_runtime.sh脚本，实现了x86_64架构的VM模块和优化的ASTC模块

### T6.4: 实现原生模块构建工具
- 优先级: 高
- 依赖: T6.3
- 描述: 实现原生模块构建工具，确保模块化架构的完整性
- 完成标准: 原生模块构建工具能够正常工作
- 状态: 进行中
- 实现: 创建了build_native_module工具，实现了原生模块的构建功能

### T7: 实现三层架构工具链
- 优先级: 高
- 依赖: T6
- 描述: 实现三层架构工具链，确保模块化架构的完整性
- 完成标准: 三层架构工具链能够正常工作
- 状态: 进行中
- 实现: 创建了build_native_module工具，实现了原生模块的构建功能

### T7.1: 实现build_native_module工具
- 优先级: 高
- 依赖: T7
- 描述: 实现build_native_module工具，确保原生模块的构建功能
- 完成标准: build_native_module工具能够正常工作
- 状态: 进行中
- 实现: 创建了build_native_module工具，实现了原生模块的构建功能

### T7.2: 实现simple_loader加载器
- 优先级: 高
- 依赖: T7
- 描述: 实现simple_loader加载器，确保模块化架构的完整性
- 完成标准: simple_loader加载器能够正常工作
- 状态: 进行中
- 实现: 创建了simple_loader加载器，实现了模块化架构的加载功能

### T7.3: 实现ASTC程序示例
- 优先级: 高
- 依赖: T7
- 描述: 实现ASTC程序示例，确保模块化架构的完整性
- 完成标准: ASTC程序示例能够正常运行
- 状态: 进行中
- 实现: 创建了ASTC程序示例，实现了模块化架构的完整性

### T7.4: 实现完整构建流程
- 优先级: 高
- 依赖: T7
- 描述: 实现完整构建流程，确保模块化架构的完整性
- 完成标准: 完整构建流程能够正常工作
- 状态: 进行中
- 实现: 创建了完整构建流程，实现了模块化架构的完整性 