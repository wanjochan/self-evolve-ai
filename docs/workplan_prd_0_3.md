# 工作计划 prd_0_3

本文档包含工作流 prd_0_3 的动态任务规划和分解。

## 工作流信息
- 工作ID: prd_0_3
- 创建时间: 2025-07-14
- 状态: ACTIVE (进行中)
- 描述: 完善测试基础设施和修复三层架构集成问题，实现Stage 1完整验证
- 总体进度: 25% (完成T3.1 - Simple Loader fallback移除)
- 特别注意：不要做历史纪录，只更新最后结果！

## 任务树

- T1 [90%] 测试基础设施完善 [PARALLEL] - 基本完成
  - T1.1 [100%] Layer 1 加载器测试脚本 - 已完成并通过
  - T1.2 [100%] Layer 2 模块测试脚本 - 已完成并通过
  - T1.3 [100%] Layer 3 程序测试脚本 - 已完成并通过(修复了错误处理)
  - T1.4 [60%] 综合集成测试脚本 - 已优化但需完善
- T2 [70%] 增强测试套件开发 [PARALLEL] - 部分完成
  - T2.1 [80%] 稳定性测试脚本 - 基本完成
  - T2.2 [80%] 性能基准测试脚本 - 基本完成
  - T2.3 [50%] 错误处理增强测试脚本 - 已修复卡死问题
- T3 [20%] 源码问题彻底修复 [CRITICAL] - T3.1已完成
  - T3.1 [100%] Simple Loader fallback机制移除 - ✅ 已完成，真实问题已暴露
  - T3.2 [0%] Pipeline模块核心TODO修复 - 9个关键TODO已识别，开始修复
  - T3.3 [0%] C99前端解析器完善 - 3个关键TODO已识别
  - T3.4 [0%] C99后端代码生成完善 - 5个关键TODO已识别
  - T3.5 [0%] Layer3编译器输出修复 - stub问题已识别
  - T3.6 [0%] Compiler模块JIT优化 - 简化实现已识别
  - T3.7 [0%] 端到端集成验证 - 等待前置任务
- T4 [0%] C99自举能力完善
  - T4.1 [0%] 依赖源文件补全
  - T4.2 [0%] 自举编译验证
  - T4.3 [0%] cc.sh依赖消除
- T5 [0%] 文档和评估更新
  - T5.1 [0%] 测试覆盖率报告
  - T5.2 [0%] 架构集成状态更新
  - T5.3 [0%] Stage 1完成度评估

## 任务详情

### T1: 测试基础设施完善
- 优先级: 高
- 依赖: 无
- 描述: 根据PRD.md要求创建缺失的核心测试脚本，建立完整的三层架构测试覆盖

### T1.1: Layer 1 加载器测试脚本
- 优先级: 高
- 依赖: 无
- 描述: 创建test_layer1_loader.sh，测试simple_loader的架构检测、模块加载和ASTC程序执行功能
- 完成标准: 脚本创建完成，覆盖基础加载机制，测试通过

### T1.2: Layer 2 模块测试脚本
- 优先级: 高
- 依赖: 无
- 描述: 创建test_layer2_modules.sh，验证pipeline、layer0、compiler、libc模块的构建和运行
- 完成标准: 脚本创建完成，覆盖核心模块独立性和依赖管理，测试通过

### T1.3: Layer 3 程序测试脚本
- 优先级: 高
- 依赖: 无
- 描述: 创建test_layer3_programs.sh，验证C99编译器和工具链的端到端功能
- 完成标准: 脚本创建完成，覆盖高级程序构建，测试通过

### T1.4: 综合集成测试脚本
- 优先级: 高
- 依赖: T1.1, T1.2, T1.3
- 描述: 创建test_comprehensive_integration.sh，验证三层架构整体协作
- 完成标准: 脚本创建完成，覆盖从加载到程序执行的完整流程，测试通过

### T2: 增强测试套件开发
- 优先级: 中
- 依赖: T1
- 描述: 开发高级测试脚本，提供稳定性、性能和错误处理的深度验证

### T2.1: 稳定性测试脚本
- 优先级: 中
- 依赖: T1.4
- 描述: 创建test_stability_enhanced.sh，包括重复加载、并发访问、长时间运行、边界条件测试
- 完成标准: 脚本创建完成，稳定性验证通过

### T2.2: 性能基准测试脚本
- 优先级: 中
- 依赖: T1.4
- 描述: 创建test_performance_benchmark.sh，建立模块加载、编译执行、内存使用性能基线
- 完成标准: 脚本创建完成，性能基线数据建立

### T2.3: 错误处理增强测试脚本
- 优先级: 中
- 依赖: T1.4
- 描述: 创建test_error_handling_enhanced.sh，验证文件系统错误、参数错误、模块错误处理
- 完成标准: 脚本创建完成，错误处理验证通过

### T3: 源码问题彻底修复 [CRITICAL]
- 优先级: 最高
- 依赖: T1
- 描述: 基于完整源码扫描结果，彻底修复所有TODO、简化实现、fallback机制，实现完整功能

### T3.1: Simple Loader fallback机制移除 (启动修复)
- 优先级: 最高 (第一步)
- 依赖: T1.1, T1.2
- 描述: 移除simple_loader.c中的fallback机制，让真正的问题暴露出来
- 文件: src/layer1/simple_loader.c (338行)
- 关键修复项目:
  - 移除行85的builtin_vm_execute_astc函数定义
  - 移除行322-323的Pipeline模块跳过逻辑
  - 移除行325的fallback调用
  - 修复Pipeline模块加载的真正问题
  - 实现完整的三层架构加载流程
- 完成标准: Simple Loader尝试正常加载Pipeline模块，段错误能够正确暴露

### T3.2: Pipeline模块核心TODO修复 (核心功能实现)
- 优先级: 最高 (第二步)
- 依赖: T3.1
- 描述: 实现pipeline_module.c中缺失的核心功能
- 文件: src/core/modules/pipeline_module.c (6493行)
- 关键修复项目:
  - 行207: 实现字符串表管理系统
  - 行213: 实现符号表查找机制
  - 行310: 实现地址计算功能
  - 行315: 实现内存加载功能
  - 行339: 实现函数索引查找
  - 行352,366: 实现结构体成员偏移量计算
  - 行385: 实现动态元素大小计算
  - 行400: 实现完整的类型转换指令系统
  - 行272-273,276-277: 实现逻辑与/或的短路求值
- 完成标准: Pipeline模块核心功能完整，能够正常加载和执行

### T3.3: C99前端解析器完善 (编译器基础)
- 优先级: 高
- 依赖: T3.1, T3.2
- 描述: 实现C99前端解析器的完整功能
- 文件: src/c99/frontend/c99_parser.c (1403行)
- 关键修复项目:
  - 行269: 实现完整的返回类型解析，移除跳过逻辑
  - 行295: 实现完整的参数解析，移除跳过逻辑
  - 行344: 实现语句添加到复合语句的功能
  - 移除所有"Skip...for now"的临时实现
- 完成标准: C99前端能够正确解析完整的C99语法

### T3.4: C99后端代码生成完善 (编译器核心)
- 优先级: 高
- 依赖: T3.3
- 描述: 实现C99后端代码生成的完整功能
- 文件: src/c99/backend/c99_codegen.c (808行)
- 关键修复项目:
  - 行182: 实现全局变量声明处理
  - 行552-553: 实现行号和列号获取
  - 行673: 实现变量查找机制
  - 行795: 实现函数查找机制
- 完成标准: C99后端能够生成正确的ASTC字节码

### T3.5: Layer3编译器输出修复 (可执行文件生成)
- 优先级: 高
- 依赖: T3.4
- 描述: 修复Layer3编译器的输出，生成真正的可执行文件
- 文件: src/layer3/c99_compiler.c (133行)
- 关键修复项目:
  - 行105-108: 移除shell脚本stub
  - 实现真正的可执行文件生成逻辑
- 完成标准: C99编译器能够生成真正的可执行文件

### T3.6: Compiler模块JIT优化 (性能提升)
- 优先级: 中
- 依赖: T3.2
- 描述: 完善compiler_module.c中的JIT编译功能
- 文件: src/core/modules/compiler_module.c (1392行)
- 关键修复项目:
  - 行362: 完善ARM64函数序言
  - 行468,492: 实现完整的多寄存器支持
  - 移除所有"简化实现"标注
- 完成标准: Compiler模块提供完整的JIT编译功能

### T3.7: 端到端集成验证 (系统验证)
- 优先级: 高
- 依赖: T3.1, T3.2, T3.3, T3.4, T3.5
- 描述: 验证修复后的完整三层架构端到端集成功能
- 验证内容:
  - Simple Loader能够正常加载Pipeline模块
  - Pipeline模块能够正确处理ASTC程序
  - C99编译器能够生成正确的可执行文件
  - 整个三层架构流程无fallback机制
- 完成标准: 完整的三层架构流程验证通过，所有TODO和简化实现已修复

### T4: C99自举能力完善
- 优先级: 高
- 依赖: T3.3, T3.4, T3.5
- 描述: 基于修复后的完整C99编译器，实现完全的编译器自举能力

### T4.1: 依赖源文件补全
- 优先级: 高
- 依赖: T3.3
- 描述: 基于完整的C99编译器实现，识别并补全自动构建所需的缺失源文件
- 完成标准: C99编译器可以完全自动构建，无缺失依赖

### T4.2: 自举编译验证
- 优先级: 高
- 依赖: T4.1
- 描述: 验证完整的C99编译器可以编译自身的完整源代码
- 完成标准: C99编译器成功编译自身，生成功能完整的编译器

### T4.3: cc.sh依赖消除
- 优先级: 中
- 依赖: T4.2
- 描述: 消除对cc.sh的依赖，实现纯C99编译器自举
- 完成标准: 完全移除cc.sh依赖，实现真正的编译器独立性

### T5: 文档和评估更新
- 优先级: 中
- 依赖: T1, T2, T3, T4
- 描述: 更新项目文档和评估报告，反映最新的实现状态

### T5.1: 测试覆盖率报告
- 优先级: 中
- 依赖: T1, T2
- 描述: 生成详细的测试覆盖率报告，更新PRD.md测试部分
- 完成标准: 测试覆盖率报告完成，PRD.md更新

### T5.2: 架构集成状态更新
- 优先级: 中
- 依赖: T3
- 描述: 更新三层架构集成状态文档，反映修复后的状态
- 完成标准: 架构集成文档更新完成

### T5.3: Stage 1完成度评估
- 优先级: 中
- 依赖: T4
- 描述: 重新评估Stage 1的完成度，更新实施评估报告
- 完成标准: Stage 1完成度评估更新，目标达到95%+

## 并行任务管理

### 并行任务组定义
使用 `[PARALLEL]` 标记可以并行执行的任务组：

1. **T1 测试基础设施完善 [PARALLEL]**
   - 并行原因: 不同层的测试脚本可以独立开发
   - 同步点: 所有基础测试脚本完成后进行集成测试
   - 预期时间节省: 60%

2. **T2 增强测试套件开发 [PARALLEL]**
   - 并行原因: 不同类型的增强测试可以并行开发
   - 同步点: 基础测试完成后
   - 预期时间节省: 50%

### 并行执行策略
- **资源分配**: 确保每个测试脚本开发有足够的时间和注意力
- **依赖管理**: 明确测试脚本间的依赖关系和执行顺序
- **进度监控**: 实时跟踪各测试脚本的开发和验证进度
- **风险控制**: 识别并行开发可能带来的接口不一致风险

### 同步检查点
- T1.1, T1.2, T1.3完成后，T1.4可以开始
- T1完成后，T2和T3可以并行开始
- T3完成后，T4可以开始
- 所有任务完成后，T5进行最终整合

## 动态规划笔记

### 关键发现和策略调整
- **源码扫描揭示了问题的真实规模**: 发现68个具体问题，远超预期
- **Pipeline模块是核心瓶颈**: 43个问题集中在pipeline_module.c，必须优先解决
- **Fallback机制掩盖了真实问题**: Simple Loader的fallback阻止了问题暴露
- **TODO标记表明功能不完整**: 大量核心功能仅有占位符实现
- **简化实现影响系统稳定性**: 关键算法的简化导致功能缺失

### 执行策略
- **T3任务优先级提升为最高**: 源码修复是所有其他任务的基础
- **采用深度优先策略**: 彻底解决Pipeline模块问题后再进行其他任务
- **移除所有fallback机制**: 确保问题能够正确暴露和解决
- **实现完整功能而非简化版本**: 不接受任何占位符或简化实现
- **建立严格的代码质量标准**: 禁止TODO、简化实现、fallback进入主分支

### 风险控制
- **Pipeline模块修复复杂度高**: 需要实现字符串表、符号表、类型系统等核心组件
- **移除fallback可能暴露更多问题**: 准备应对连锁反应
- **工作量大幅增加**: 68个问题的修复需要大量时间和精力
- **系统稳定性风险**: 大规模修改可能引入新的问题

### 质量保证措施
- **每个修复都必须有对应测试**: 确保修复的正确性
- **渐进式修复和验证**: 避免一次性大规模修改
- **保持向后兼容性**: 修复过程中不破坏现有功能
- **建立回归测试**: 防止修复引入新问题
