# Stage 1 Core Modules Makefile
# ä¿®å¤ç¼–è¯‘ä¾èµ–é—®é¢˜ï¼Œç¡®ä¿æ‰€æœ‰æ¨¡å—èƒ½å¤Ÿæ­£ç¡®æ„å»º

CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -O2 -fPIC -I.
LDFLAGS = -shared

# æ ¸å¿ƒæ–‡ä»¶
CORE_SOURCES = astc.c
CORE_OBJECTS = $(CORE_SOURCES:.c=.o)

# æ¨¡å—æ–‡ä»¶
MODULE_SOURCES = modules/pipeline_module.c modules/c99bin_module.c modules/compiler_module.c modules/libc_module.c
MODULE_OBJECTS = $(MODULE_SOURCES:.c=.o)

# ç›®æ ‡æ–‡ä»¶
TARGETS = libastc_core.so \
          modules/pipeline_module.so \
          modules/c99bin_module.so \
          modules/compiler_module.so \
          modules/libc_module.so

.PHONY: all clean test

all: $(TARGETS)

# æ„å»ºæ ¸å¿ƒåº“
libastc_core.so: $(CORE_OBJECTS)
	$(CC) $(LDFLAGS) -o $@ $^

# æ„å»ºæ¨¡å—
modules/%.so: modules/%.o libastc_core.so
	$(CC) $(LDFLAGS) -o $@ $< -L. -lastc_core

# ç¼–è¯‘è§„åˆ™
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# æµ‹è¯•ç¼–è¯‘
test: all
	@echo "âœ… æ‰€æœ‰Stage 1æ ¸å¿ƒæ¨¡å—ç¼–è¯‘æˆåŠŸ"
	@echo "ğŸ“¦ ç”Ÿæˆçš„åº“æ–‡ä»¶:"
	@ls -la *.so modules/*.so 2>/dev/null || true

# æ¸…ç†
clean:
	rm -f $(CORE_OBJECTS) $(MODULE_OBJECTS) $(TARGETS)
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# å®‰è£…
install: all
	mkdir -p ../../lib
	cp *.so ../../lib/
	cp modules/*.so ../../lib/
	@echo "ğŸ“¦ å·²å®‰è£…åˆ° ../../lib/"